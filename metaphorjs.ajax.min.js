(function(){var m,n;if("undefined"!=typeof global)try{m=require("metaphorjs-promise"),n=require("metaphorjs-observable")}catch(O){m=global.MetaphorJs.lib.Promise,n=global.MetaphorJs.lib.Observable}else m=window.MetaphorJs.lib.Promise,n=window.MetaphorJs.lib.Observable;var k=function(a,b,c){for(var d in b)!b.hasOwnProperty(d)||void 0!=typeof a[d]&&!1===c||(a[d]=b[d])},h=function(a,b){return function(){a.apply(b,arguments)}},p;"undefined"!=typeof window&&(p=document.querySelectorAll||function(a){var b=
document,c=b.documentElement.firstChild,d=b.createElement("STYLE");c.appendChild(d);b.__qsaels=[];d.sheet.insertRule(a+"{x:expression(document.__qsaels.push(this))}",0);window.scrollBy(0,0);return b.__qsaels});var I=/#.*$/,v=/([?&])_=[^&]*/,q=/\?/,w=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,J=/^(?:GET|HEAD)$/i,x=0,K=function(a,b){setTimeout(function(){a.call(b)},0)},l=function(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)},y=function(){return String.prototype.trim?
function(a){return"string"==typeof a?a.trim():a}:function(a){return"string"==typeof a?a.replace(/^\s\s*/,"").replace(/\s\s*$/,""):a}}(),z=function(a,b){var c,d;if(!a||"string"!==typeof a)return null;try{d=new DOMParser,c=d.parseFromString(a,b||"text/xml")}catch(e){c=void 0}if(!c||c.getElementsByTagName("parsererror").length)throw"Invalid XML: "+a;return c},r=function(a,b,c){var d,e;if("string"==typeof a&&c)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a));else if(A(a)&&c)for(d=0,e=a.length;d<
e;d++)r(a[d],b,c+"["+d+"]");else if("object"==typeof a)for(d in a)a.hasOwnProperty(d)&&r(a[d],b,c?c+"["+d+"]":d)},L=function(a,b){a.replace(I,"");if(!1===b.cache){var c=(new Date).getTime();return v.test(a)?a.replace(v,"$1_="+c):a+(q.test(a)?"&":"?")+"_="+c}!b.data||b.data instanceof window.FormData||("string"!=typeof b.data?(c=[],r(b.data,c,null),c=c.join("&").replace(/%20/g,"+")):c=b.data,b.data=c,J.test(b.method)&&(a+=(q.test(a)?"&":"?")+b.data,b.data=null));return a},s={xml:"application/xml, text/xml",
html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},M={url:null,data:null,method:"GET",headers:null,username:null,password:null,body:null,cache:null,type:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpName:null,jsonpCallback:null,transport:null,replace:!1,selector:null,form:null,progress:null,uploadProgress:null},B={},g=new n,C=function(a){var b;b=eval;
a&&(/^[^\S]*use strict/.test(a)?(b=document.createElement("script"),b.text=a,document.head.appendChild(b).parentNode.removeChild(b)):b(a))},A=function(a){return a&&"object"==typeof a&&"number"==typeof a.length&&"[object Array]"==Object.prototype.toString.call(a)||!1},t=function(a,b,c){var d,e;if("string"==typeof a&&c)d=document.createElement("input"),d.setAttribute("type","hidden"),d.setAttribute("name",c),d.setAttribute("value",a),b.appendChild(d);else if(A(a)&&c)for(d=0,e=a.length;d<e;d++)t(a[d],
b,c+"["+d+"]");else if("object"==typeof a)for(d in a)a.hasOwnProperty(d)&&t(a[d],b,c?c+"["+d+"]":d)},N=function(a){for(var b,c,d="",e=0;e<a.elements.length;e++)if(b=a.elements[e],b.hasAttribute("name"))if(c="INPUT"===b.nodeName.toUpperCase()?b.getAttribute("type").toUpperCase():"TEXT","FILE"===c)for(c=0;c<b.files.length;d+="&"+encodeURIComponent(b.name)+"="+encodeURIComponent(b.files[c++].name));else if("RADIO"!==c&&"CHECKBOX"!==c||b.checked)d+="&"+encodeURIComponent(b.name)+"="+encodeURIComponent(b.value);
return d},u=function(){},D=function(a,b,c){var d=b?b.dataType:null;b=b?b.selector:null;if("string"!=typeof a)return a;c=c||"";if("xml"===d||!d&&0<=c.indexOf("xml"))return a=z(y(a)),b?p.call(a,b):a;if("html"===d)return a=z(a,"text/html"),b?p.call(a,b):a;if("fragment"==d){c=document.createDocumentFragment();d=document.createElement("div");for(d.innerHTML=a;d.firstChild;)c.appendChild(d.firstChild);return c}if("json"===d||!d&&0<=c.indexOf("json"))return a=y(a),JSON.parse(a);("script"===d||!d&&0<=c.indexOf("javascript"))&&
C(a);return a+""},H=function(a){var b=w.exec(("undefined"!=typeof window?window.location.href:"").toLowerCase())||[],c=w.exec(a.url.toLowerCase());a.crossDomain=!(!c||c[1]===b[1]&&c[2]===b[2]&&(c[3]||("http:"===c[1]?"80":"443"))===(b[3]||("http:"===b[1]?"80":"443")));b=new m;"iframe"!=a.transport||a.form?a.form&&(this._form=a.form,"POST"!=a.method||"undefined"!=typeof window&&window.FormData||"iframe"==a.transport||(a.transport="iframe")):this.createForm();a.form&&"iframe"!=a.transport&&(a.data="POST"==
a.method?new FormData(a.form):N(a.form));a.url=L(a.url,a);c=!a.crossDomain&&"script"!=a.transport||a.form?"iframe"==a.transport?new E(a,b,this):new F(a,b,this):new G(a,b,this);this._deferred=b;this._transport=c;this._opt=a;b.done(function(a){g.trigger("success",a)});b.fail(function(a){g.trigger("error",a)});b.always(function(){g.trigger("end")});g.trigger("start");a.timeout&&(this._timeout=setTimeout(h(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();K(c.send,c);a=b.promise();a.abort=
h(this.abort,this);b.always(this.destroy,this);return a};k(H.prototype,{_jsonpName:null,_transport:null,_opt:null,_deferred:null,_timeout:null,_form:null,_removeForm:!1,abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=document.createElement("form");a.style.display="none";t(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},createJsonp:function(){var a=this._opt,b=
a.jsonpName||"callback",c=a.jsonpCallback||"jsonp_"+ ++x;a.url+=(q.test(a.url)?"&":"?")+b+"="+c;this._jsonpName=c;"undefined"!=typeof window&&(window[c]=h(this.jsonpCallback,this));"undefined"!=typeof global&&(global[c]=h(this.jsonpCallback,this));return c},jsonpCallback:function(a){try{this._deferred.resolve(D(a,this._opt.dataType))}catch(b){this._deferred.reject(b)}},processResponseData:function(a,b){var c=this._deferred,d;if(this._opt.jsonp)if(a){try{C(a)}catch(e){c.reject(e)}c.isPending()&&c.reject("jsonp script didn't invoke callback")}else c.reject("jsonp script is empty");
else try{a=D(a,this._opt,b),d=g.trigger("processResponse",a),c.resolve(d||a)}catch(f){c.reject(f)}},destroy:function(){this._timeout&&clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();delete this._transport;delete this._opt;delete this._deferred;delete this._timeout;delete this._form;this._jsonpName&&("undefined"!=typeof window&&delete window[this._jsonpName],"undefined"!=typeof global&&delete global[this._jsonpName])}},
!0);var f=function(a,b){b=b||{};a&&"string"!=typeof a?b=a:b.url=a;if(!b.url&&(b.form&&(b.url=b.form.getAttribute("action")),!b.url))throw"Must provide url";k(b,B,!1);k(b,M,!1);b.method=b.method?b.method.toUpperCase():b.form?b.form.getAttribute("method").toUpperCase()||"GET":"GET";return!1===g.trigger("beforeSend",b.url,b)?m.reject():new H(b)};f.setup=function(a){k(B,a,!0)};f.on=function(){g.on.apply(g,arguments)};f.un=function(){g.un.apply(g,arguments)};f.get=function(a,b){b=b||{};b.method="GET";
return f(a,b)};f.post=function(a,b){b=b||{};b.method="POST";return f(a,b)};f.load=function(a,b,c){c=c||{};"string"!=typeof b&&(c=b);c.dataType="fragment";return f(b,c).done(function(b){if(c.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(b)})};f.loadScript=function(a){return f(a,{transport:"script"})};f.submit=function(a,b){b=b||{};b.form=a;return f(null,b)};var F=function(a,b,c){var d;if(!(d=new XMLHttpRequest)&&!(d=new ActiveXObject("Msxml2.XMLHTTP"))&&!(d=new ActiveXObject("Microsoft.XMLHTTP")))throw"Unable to create XHR object";
this._xhr=d;this._deferred=b;this._opt=a;this._ajax=c;a.progress&&l(d,"progress",a.progress);a.uploadProgress&&d.upload&&l(d.upload,"progress",a.uploadProgress);d.open(a.method,a.url,!0,a.username,a.password);try{var e;if(a.xhrFields)for(e in a.xhrFields)d[e]=a.xhrFields[e];a.data&&a.contentType&&d.setRequestHeader("Content-Type",a.contentType);d.setRequestHeader("X-Requested-With","XMLHttpRequest");d.setRequestHeader("Accept",a.dataType&&s[a.dataType]?s[a.dataType]+", */*; q=0.01":s._default);for(e in a.headers)d.setRequestHeader(e,
a.headers[e])}catch(f){}a.beforeSend&&a.beforeSend(d);d.onreadystatechange=h(this.onReadyStateChange,this)};k(F.prototype,{_xhr:null,_deferred:null,_ajax:null,onReadyStateChange:function(){var a=this._xhr,b=this._deferred;if(0===a.readyState)a.onreadystatechange=u,b.resolve(a);else if(4===a.readyState){a.onreadystatechange=u;var c;a:{try{c=!a.status&&"undefined"!=typeof location&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(d){}c=!1}c?this._ajax.processResponseData("string"==
typeof a.responseText?a.responseText:void 0,a.getResponseHeader("content-type")||""):b.reject(a)}},abort:function(){this._xhr.onreadystatechange=u;this._xhr.abort()},send:function(){try{this._xhr.send(this._opt.data)}catch(a){this._deferred.reject(a)}},destroy:function(){delete this._xhr;delete this._deferred;delete this._opt;delete this._ajax}},!0);var G=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};k(G.prototype,{_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("script");
a.setAttribute("async","async");a.setAttribute("charset","utf-8");a.setAttribute("src",this._opt.url);l(a,"load",h(this.onLoad,this));l(a,"error",h(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;
delete this._ajax;delete this._deferred}},!0);var E=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};k(E.prototype,{_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),b="frame-"+ ++x,c=this._opt.form;a.setAttribute("id",b);a.setAttribute("name",b);a.style.display="none";document.body.appendChild(a);c.setAttribute("action",this._opt.url);c.setAttribute("target",b);l(a,"load",h(this.onLoad,this));l(a,"error",h(this.onError,this));this._el=a;
try{c.submit()}catch(d){this._deferred.reject(d)}},onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponseData(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}},!0);
"undefined"!=typeof global?module.exports=f:window.MetaphorJs?MetaphorJs.ajax=f:window.MetaphorJs={ajax:f}})();
