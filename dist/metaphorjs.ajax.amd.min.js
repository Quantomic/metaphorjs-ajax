define("metaphorjs-ajax",["metaphorjs-observable","metaphorjs-promise","metaphorjs-select"],function(M,v,C){var w=Array.prototype.slice,s=function(g){return!(!g||g.constructor!==Object)},g=function(g){return"undefined"==typeof g},x=function e(){var f=!1,m=!1,q=w.call(arguments),n=q.shift(),k,h,l;"boolean"==typeof q[q.length-1]&&(f=q.pop());"boolean"==typeof q[q.length-1]&&(m=f,f=q.pop());for(;q.length;)if(k=q.shift())for(h in k)if(k.hasOwnProperty(h)&&!g(l=k[h]))if(m)if(n[h]&&s(n[h])&&s(l))e(n[h],
l,f,m);else{if(!0===f||g(n[h])||null===n[h])s(l)?(n[h]={},e(n[h],l,f,!0)):n[h]=l}else if(!0===f||g(n[h])||null===n[h])n[h]=l;return n},k=Function.prototype.bind?function(e,f){return e.bind(f)}:function(e,f){return function(){return e.apply(f,arguments)}},l=function(e){return"string"==typeof e},D=function(){return String.prototype.trim?function(e){return l(e)?e.trim():e}:function(e){return l(e)?e.replace(/^\s\s*/,"").replace(/\s\s*$/,""):e}}(),N=function(e,f,m){setTimeout(function(){e.apply(f,m||[])},
0)},y=function(){},O=function(){return g(JSON)?function(e){return JSON.parse(e)}:function(e){return(new Function("return "+e))()}}(),E=function(e,f){var m,g;if(!e||!l(e))return null;try{g=new DOMParser,m=g.parseFromString(e,f||"text/xml")}catch(k){m=void 0}if(!m||m.getElementsByTagName("parsererror").length)throw"Invalid XML: "+e;return m},z=Object.prototype.toString,u=function(e){return null!=e&&"object"===typeof e},F=function(e){var f;if(f=e&&u(e))f=e.length,f="number"==typeof f&&!isNaN(f);return!(!f||
"[object Array]"!=z.call(e))},t=function(e,f,g){e.attachEvent?e.attachEvent("on"+f,g):e.addEventListener(f,g,!1)};return function(){var e=/#.*$/,f=/([?&])_=[^&]*/,m=/\?/,q=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=/^(?:GET|HEAD)$/i,s=0,h=function(a,b,c){var d,e;if(l(a)&&c)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a));else if(F(a)&&c)for(d=0,e=a.length;d<e;d++)h(a[d],b,c+"["+d+"]");else if(u(a))for(d in a)a.hasOwnProperty(d)&&h(a[d],b,c?c+"["+d+"]":d)},w=function(a,b){a.replace(e,
"");if(!1===b.cache){var c=(new Date).getTime();return f.test(a)?a.replace(f,"$1_="+c):a+(m.test(a)?"&":"?")+"_="+c}!b.data||window.FormData&&b.data instanceof window.FormData||(l(b.data)?c=b.data:(c=[],h(b.data,c,null),c=c.join("&").replace(/%20/g,"+")),b.data=c,n.test(b.method)&&(a+=(m.test(a)?"&":"?")+b.data,b.data=null));return a},A={xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},
z={url:null,data:null,method:"GET",headers:null,username:null,password:null,cache:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpParam:null,jsonpCallback:null,transport:null,replace:!1,selector:null,form:null,beforeSend:null,progress:null,uploadProgress:null,processResponse:null,callbackScope:null},G={},r=new M,H=function(a){var b;b=eval;a&&(/^[^\S]*use strict/.test(a)?(b=document.createElement("script"),b.text=a,document.head.appendChild(b).parentNode.removeChild(b)):
b(a))},B=function(a,b,c){var d,e;if(!u(a)&&"function"!==typeof a&&c)d=document.createElement("input"),d.setAttribute("type","hidden"),d.setAttribute("name",c),d.setAttribute("value",a),b.appendChild(d);else if(F(a)&&c)for(d=0,e=a.length;d<e;d++)B(a[d],b,c+"["+d+"]");else if(u(a))for(d in a)a.hasOwnProperty(d)&&B(a[d],b,c?c+"["+d+"]":d)},P=function(a){for(var b,c,d="",e=0;e<a.elements.length;e++)if(b=a.elements[e],b.hasAttribute("name"))if(c="INPUT"===b.nodeName.toUpperCase()?b.getAttribute("type").toUpperCase():
"TEXT","FILE"===c)for(c=0;c<b.files.length;d+="&"+encodeURIComponent(b.name)+"="+encodeURIComponent(b.files[c++].name));else if("RADIO"!==c&&"CHECKBOX"!==c||b.checked)d+="&"+encodeURIComponent(b.name)+"="+encodeURIComponent(b.value);return d},Q=function(a,b,c){var d=b?b.dataType:null;b=b?b.selector:null;if(!l(a))return a;c=c||"";if("xml"===d||!d&&0<=c.indexOf("xml"))return a=E(D(a)),b?C(b,a):a;if("html"===d)return a=E(a,"text/html"),b?C(b,a):a;if("fragment"==d){c=document.createDocumentFragment();
d=document.createElement("div");for(d.innerHTML=a;d.firstChild;)c.appendChild(d.firstChild);return c}if("json"===d||!d&&0<=c.indexOf("json"))return O(D(a));("script"===d||!d&&0<=c.indexOf("javascript"))&&H(a);return a+""},L=function(a){var b=g(window)?"":window.location.href,b=q.exec(b.toLowerCase())||[],c=q.exec(a.url.toLowerCase());this._opt=a;a.crossDomain=!(!c||c[1]===b[1]&&c[2]===b[2]&&(c[3]||("http:"===c[1]?"80":"443"))===(b[3]||("http:"===b[1]?"80":"443")));b=new v;"iframe"!=a.transport||a.form?
a.form&&(this._form=a.form,"POST"!=a.method||!g(window)&&window.FormData||"iframe"==a.transport||(a.transport="iframe")):(this.createForm(),a.form=this._form);a.form&&"iframe"!=a.transport&&(a.data="POST"==a.method?new FormData(a.form):P(a.form));a.url=w(a.url,a);c=!a.crossDomain&&"script"!=a.transport||a.form?"iframe"==a.transport?new I(a,b,this):new J(a,b,this):new K(a,b,this);this._deferred=b;this._transport=c;b.done(function(a){r.trigger("success",a)});b.fail(function(a){r.trigger("error",a)});
b.always(function(){r.trigger("end")});r.trigger("start");a.timeout&&(this._timeout=setTimeout(k(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();!1===r.trigger("beforeSend",a,c)&&(this._promise=v.reject());a.beforeSend&&!1===a.beforeSend.call(a.callbackScope,a,c)&&(this._promise=v.reject());this._promise||(N(c.send,c),b.abort=k(this.abort,this),b.always(this.destroy,this),this._promise=b)};L.prototype={_jsonpName:null,_transport:null,_opt:null,_deferred:null,_promise:null,_timeout:null,
_form:null,_removeForm:!1,promise:function(){return this._promise},abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=document.createElement("form");a.style.display="none";a.setAttribute("method",this._opt.method);B(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},createJsonp:function(){var a=this._opt,b=a.jsonpParam||"callback",c=a.jsonpCallback||"jsonp_"+ ++s;a.url+=
(m.test(a.url)?"&":"?")+b+"="+c;this._jsonpName=c;g(window)||(window[c]=k(this.jsonpCallback,this));g(global)||(global[c]=k(this.jsonpCallback,this));return c},jsonpCallback:function(a){try{this._deferred.resolve(this.processResponseData(a))}catch(b){this._deferred.reject(b)}},processResponseData:function(a,b){var c=this._opt;a=Q(a,c,b);r.hasListener("processResponse")&&(a=r.trigger("processResponse",a,this._deferred));c.processResponse&&(a=c.processResponse.call(c.callbackScope,a,this._deferred));
return a},processResponse:function(a,b){var c=this._deferred,d;if(this._opt.jsonp)if(a){try{H(a)}catch(e){c.reject(e)}c.isPending()&&c.reject("jsonp script didn't invoke callback")}else c.reject("jsonp script is empty");else{try{d=this.processResponseData(a,b)}catch(f){c.reject(f)}c.resolve(d)}},destroy:function(){this._timeout&&clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();delete this._transport;
delete this._opt;delete this._deferred;delete this._promise;delete this._timeout;delete this._form;this._jsonpName&&(g(window)||delete window[this._jsonpName],g(global)||delete global[this._jsonpName])}};var p=function(a,b){b=b||{};a&&!l(a)?b=a:b.url=a;if(!b.url&&(b.form&&(b.url=b.form.getAttribute("action")),!b.url))throw"Must provide url";x(b,G,!1,!0);x(b,z,!1,!0);b.method=b.method?b.method.toUpperCase():b.form?b.form.getAttribute("method").toUpperCase()||"GET":"GET";return(new L(b)).promise()};
p.setup=function(a){x(G,a,!0,!0)};p.on=function(){r.on.apply(r,arguments)};p.un=function(){r.un.apply(r,arguments)};p.get=function(a,b){b=b||{};b.method="GET";return p(a,b)};p.post=function(a,b){b=b||{};b.method="POST";return p(a,b)};p.load=function(a,b,c){c=c||{};l(b)||(c=b);c.dataType="fragment";return p(b,c).done(function(b){if(c.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(b)})};p.loadScript=function(a){return p(a,{transport:"script"})};p.submit=function(a,b){b=b||{};b.form=
a;return p(null,b)};var J=function(a,b,c){var d;if(!(window.XMLHttpRequest&&(d=new XMLHttpRequest)||(d=new ActiveXObject("Msxml2.XMLHTTP"))||(d=new ActiveXObject("Microsoft.XMLHTTP"))))throw"Unable to create XHR object";this._xhr=d;this._deferred=b;this._opt=a;this._ajax=c;a.progress&&t(d,"progress",k(a.progress,a.callbackScope));a.uploadProgress&&d.upload&&t(d.upload,"progress",k(a.uploadProgress,a.callbackScope));try{var e;if(a.xhrFields)for(e in a.xhrFields)d[e]=a.xhrFields[e];a.data&&a.contentType&&
d.setRequestHeader("Content-Type",a.contentType);d.setRequestHeader("X-Requested-With","XMLHttpRequest");d.setRequestHeader("Accept",a.dataType&&A[a.dataType]?A[a.dataType]+", */*; q=0.01":A._default);for(e in a.headers)d.setRequestHeader(e,a.headers[e])}catch(f){}d.onreadystatechange=k(this.onReadyStateChange,this)};J.prototype={_xhr:null,_deferred:null,_ajax:null,onReadyStateChange:function(){var a=this._xhr,b=this._deferred;if(0===a.readyState)a.onreadystatechange=y,b.resolve(a);else if(4===a.readyState){a.onreadystatechange=
y;var c;a:{try{c=!a.status&&!g(location)&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(d){}c=!1}c?this._ajax.processResponse(l(a.responseText)?a.responseText:void 0,a.getResponseHeader("content-type")||""):b.reject(a)}},abort:function(){this._xhr.onreadystatechange=y;this._xhr.abort()},send:function(){var a=this._opt;try{this._xhr.open(a.method,a.url,!0,a.username,a.password),this._xhr.send(a.data)}catch(b){this._deferred.reject(b)}},destroy:function(){delete this._xhr;
delete this._deferred;delete this._opt;delete this._ajax}};var K=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};K.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("script");a.setAttribute("async","async");a.setAttribute("charset","utf-8");a.setAttribute("src",this._opt.url);t(a,"load",k(this.onLoad,this));t(a,"error",k(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},
onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};var I=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};I.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),b="frame-"+ ++s,c=this._opt.form;a.setAttribute("id",
b);a.setAttribute("name",b);a.style.display="none";document.body.appendChild(a);c.setAttribute("action",this._opt.url);c.setAttribute("target",b);t(a,"load",k(this.onLoad,this));t(a,"error",k(this.onError,this));this._el=a;try{c.submit()}catch(d){this._deferred.reject(d)}},onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponse(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&
this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};return p}()});
