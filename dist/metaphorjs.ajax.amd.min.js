'use strict';define("metaphorjs-ajax",["metaphorjs-observable","metaphorjs-promise","metaphorjs-select"],function(O,x,D){function s(b){return"object"==typeof b&&3===u(b)&&!b.nodeType&&b.constructor===Object}function v(b){return!0===b||!1===b}function m(b){return"string"==typeof b||b===""+b}function E(b,e,f,g){setTimeout(function(){b.apply(e,f||[])},g||0)}function y(){}function F(b,e){var f,g;if(!b||!m(b))return null;try{g=new DOMParser,f=g.parseFromString(b,e||"text/xml")}catch(n){f=void 0}if(!f||
f.getElementsByTagName("parsererror").length)throw"Invalid XML: "+b;return f}function t(b,e,f){b.attachEvent?b.attachEvent("on"+e,f):b.addEventListener(e,f,!1)}function z(b){if(null===b||"object"!=typeof b)return!1;b=u(b);return 2<b||-1==b}function P(b){var e=b.stack||Error().stack;if("undefined"!=typeof console&&console.log)E(function(){console.log(b);e&&console.log(e)});else throw b;}function w(b,e){return b.getAttribute?b.getAttribute(e):null}var A=Array.prototype.slice,B=Object.prototype.toString,
u=function(){var b={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(e){if(!e){if(null===e)return 6;if(void 0===e)return 7}var f=b[B.call(e)];return void 0===f?-1:1==f&&isNaN(e)?8:f}}(),r=function(){return function e(){var f=!1,g=!1,n=A.call(arguments),k=n.shift(),m,h,q;v(n[n.length-1])&&(f=n.pop());v(n[n.length-1])&&(g=f,f=n.pop());for(;n.length;)if(m=n.shift())for(h in m)if(m.hasOwnProperty(h)&&
void 0!==(q=m[h]))if(g)if(k[h]&&s(k[h])&&s(q))e(k[h],q,f,g);else{if(!0===f||void 0==k[h])s(q)?(k[h]={},e(k[h],q,f,!0)):k[h]=q}else if(!0===f||void 0==k[h])k[h]=q;return k}}(),g=Function.prototype.bind?function(b,e){return b.bind(e)}:function(b,e){return function(){return b.apply(e,arguments)}},G=function(){return String.prototype.trim?function(b){return m(b)?b.trim():b}:function(b){return m(b)?b.replace(/^\s\s*/,"").replace(/\s\s*$/,""):b}}(),Q=function(){return"undefined"!=typeof JSON?function(b){return JSON.parse(b)}:
function(b){return(new Function("return "+b))()}}(),H=function(){var b=["0","0","0"];return function(){for(var e=b.length,f;e;){e--;f=b[e].charCodeAt(0);if(57==f)return b[e]="A",b.join("");if(90==f)b[e]="0";else return b[e]=String.fromCharCode(f+1),b.join("")}b.unshift("0");return b.join("")}}();return function(){var b=/#.*$/,e=/([?&])_=[^&]*/,f=/\?/,s=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=/^(?:GET|HEAD)$/i,k=function(a,d,c){var b,e;e=u(a);if(3>e&&-1<e&&c)d.push(encodeURIComponent(c)+
"="+encodeURIComponent(""+a));else if("object"==typeof a&&5===u(a)&&c)for(b=0,e=a.length;b<e;b++)k(a[b],d,c+"["+b+"]");else if(z(a))for(b in a)a.hasOwnProperty(b)&&k(a[b],d,c?c+"["+b+"]":b)},v=function(a,d){a.replace(b,"");if(!1===d.cache){var c=(new Date).getTime();return e.test(a)?a.replace(e,"$1_="+c):a+(f.test(a)?"&":"?")+"_="+c}!d.data||window.FormData&&d.data instanceof window.FormData||(m(d.data)?c=d.data:(c=[],k(d.data,c,null),c=c.join("&").replace(/%20/g,"+")),d.data=c,n.test(d.method)&&
(a+=(f.test(a)?"&":"?")+d.data,d.data=null));return a},h={xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},q={url:null,data:null,method:"GET",headers:null,username:null,password:null,cache:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpParam:null,jsonpCallback:null,transport:null,replace:!1,selector:null,form:null,beforeSend:null,
progress:null,uploadProgress:null,processResponse:null,callbackScope:null},I={},p=new O,J=function(a){var d;d=eval;a&&(/^[^\S]*use strict/.test(a)?(d=document.createElement("script"),d.text=a,document.head.appendChild(d).parentNode.removeChild(d)):d(a))},C=function(a,d,c){var b,e;if(!z(a)&&"function"!=typeof a&&c)b=document.createElement("input"),b.setAttribute("type","hidden"),b.setAttribute("name",c),b.setAttribute("value",a),d.appendChild(b);else if("object"==typeof a&&5===u(a)&&c)for(b=0,e=a.length;b<
e;b++)C(a[b],d,c+"["+b+"]");else if(z(a))for(b in a)a.hasOwnProperty(b)&&C(a[b],d,c?c+"["+b+"]":b)},A=function(a){for(var d,c,b="",e=0;e<a.elements.length;e++)if(d=a.elements[e],null!==w(d,"name"))if(c="INPUT"===d.nodeName.toUpperCase()?w(d,"type").toUpperCase():"TEXT","FILE"===c)for(c=0;c<d.files.length;b+="&"+encodeURIComponent(d.name)+"="+encodeURIComponent(d.files[c++].name));else if("RADIO"!==c&&"CHECKBOX"!==c||d.checked)b+="&"+encodeURIComponent(d.name)+"="+encodeURIComponent(d.value);return b},
B=function(a,d,c){var b=d?d.dataType:null;d=d?d.selector:null;if(!m(a))return a;c=c||"";if("xml"===b||!b&&0<=c.indexOf("xml"))return a=F(G(a)),d?D(d,a):a;if("html"===b)return a=F(a,"text/html"),d?D(d,a):a;if("fragment"==b){c=document.createDocumentFragment();b=document.createElement("div");for(b.innerHTML=a;b.firstChild;)c.appendChild(b.firstChild);return c}if("json"===b||!b&&0<=c.indexOf("json"))return Q(G(a));("script"===b||!b&&0<=c.indexOf("javascript"))&&J(a);return a+""},N=function(a){var d=
s.exec((window?window.location.href:"").toLowerCase())||[],b=s.exec(a.url.toLowerCase());this._opt=a;!0!==a.crossDomain&&(a.crossDomain=!(!b||b[1]===d[1]&&b[2]===d[2]&&(b[3]||("http:"===b[1]?"80":"443"))===(d[3]||("http:"===d[1]?"80":"443"))));d=new x;"iframe"!=a.transport||a.form?a.form&&(this._form=a.form,"POST"!=a.method||window&&window.FormData||(a.transport="iframe")):(this.createForm(),a.form=this._form);a.form&&"iframe"!=a.transport&&(a.data="POST"==a.method?new FormData(a.form):A(a.form));
a.url=v(a.url,a);b=!a.crossDomain&&"script"!=a.transport||a.form?"iframe"==a.transport?new K(a,d,this):new L(a,d,this):new M(a,d,this);this._deferred=d;this._transport=b;d.done(function(a){p.trigger("success",a)});d.fail(function(a){p.trigger("error",a)});d.always(function(){p.trigger("end")});p.trigger("start");a.timeout&&(this._timeout=setTimeout(g(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();!1===p.trigger("beforeSend",a,b)&&(this._promise=x.reject());a.beforeSend&&!1===a.beforeSend.call(a.callbackScope,
a,b)&&(this._promise=x.reject());this._promise||(E(b.send,b),d.abort=g(this.abort,this),d.always(this.destroy,this),this._promise=d)};r(N.prototype,{_jsonpName:null,_transport:null,_opt:null,_deferred:null,_promise:null,_timeout:null,_form:null,_removeForm:!1,promise:function(){return this._promise},abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=document.createElement("form");a.style.display="none";
a.setAttribute("method",this._opt.method);C(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},createJsonp:function(){var a=this._opt,d=a.jsonpParam||"callback",b=a.jsonpCallback||"jsonp_"+H();a.url+=(f.test(a.url)?"&":"?")+d+"="+b;this._jsonpName=b;"undefined"!=typeof window&&(window[b]=g(this.jsonpCallback,this));"undefined"!=typeof global&&(global[b]=g(this.jsonpCallback,this));return b},jsonpCallback:function(a){var b;try{b=this.processResponseData(a)}catch(c){this._deferred?
this._deferred.reject(c):P(c)}this._deferred&&this._deferred.resolve(b)},processResponseData:function(a,b){var c=this._opt;a=B(a,c,b);p.hasListener("processResponse")&&(a=p.trigger("processResponse",a,this._deferred));c.processResponse&&(a=c.processResponse.call(c.callbackScope,a,this._deferred));return a},processResponse:function(a,b){var c=this._deferred,e;if(this._opt.jsonp)if(a){try{J(a)}catch(f){c.reject(f)}c.isPending()&&c.reject("jsonp script didn't invoke callback")}else c.reject("jsonp script is empty");
else{try{e=this.processResponseData(a,b)}catch(g){c.reject(g)}c.resolve(e)}},destroy:function(){this._timeout&&clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();this._form=this._timeout=this._promise=this._deferred=this._opt=this._transport=null;this._jsonpName&&("undefined"!=typeof window&&delete window[this._jsonpName],"undefined"!=typeof global&&delete global[this._jsonpName])}},!0,!1);var l=
function(a,b){b=b||{};a&&!m(a)?b=a:b.url=a;if(!b.url&&(b.form&&(b.url=w(b.form,"action")),!b.url))throw"Must provide url";r(b,I,!1,!0);r(b,q,!1,!0);b.method=b.method?b.method.toUpperCase():b.form?w(b.form,"method").toUpperCase()||"GET":"GET";return(new N(b)).promise()};l.setup=function(a){r(I,a,!0,!0)};l.on=function(){p.on.apply(p,arguments)};l.un=function(){p.un.apply(p,arguments)};l.get=function(a,b){b=b||{};b.method="GET";return l(a,b)};l.post=function(a,b){b=b||{};b.method="POST";return l(a,b)};
l.load=function(a,b,c){c=c||{};m(b)||(c=b);c.dataType="fragment";return l(b,c).done(function(b){if(c.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(b)})};l.loadScript=function(a){return l(a,{transport:"script"})};l.submit=function(a,b){b=b||{};b.form=a;return l(null,b)};var L=function(a,b,c){var e;if(!(window.XMLHttpRequest&&(e=new XMLHttpRequest)||(e=new ActiveXObject("Msxml2.XMLHTTP"))||(e=new ActiveXObject("Microsoft.XMLHTTP"))))throw"Unable to create XHR object";this._xhr=
e;this._deferred=b;this._opt=a;this._ajax=c;a.progress&&t(e,"progress",g(a.progress,a.callbackScope));a.uploadProgress&&e.upload&&t(e.upload,"progress",g(a.uploadProgress,a.callbackScope));e.onreadystatechange=g(this.onReadyStateChange,this)};r(L.prototype,{_xhr:null,_deferred:null,_ajax:null,setHeaders:function(){var a=this._opt,b=this._xhr,c;if(a.xhrFields)for(c in a.xhrFields)b[c]=a.xhrFields[c];a.data&&a.contentType&&b.setRequestHeader("Content-Type",a.contentType);b.setRequestHeader("X-Requested-With",
"XMLHttpRequest");b.setRequestHeader("Accept",a.dataType&&h[a.dataType]?h[a.dataType]+", */*; q=0.01":h._default);for(c in a.headers)b.setRequestHeader(c,a.headers[c])},onReadyStateChange:function(){var a=this._xhr,b=this._deferred;if(0===a.readyState)a.onreadystatechange=y,b.resolve(a);else if(4===a.readyState){a.onreadystatechange=y;var c;a:{try{c=!a.status&&location&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(e){}c=!1}c?this._ajax.processResponse(m(a.responseText)?
a.responseText:void 0,a.getResponseHeader("content-type")||""):b.reject(a)}},abort:function(){this._xhr.onreadystatechange=y;this._xhr.abort()},send:function(){var a=this._opt;try{this._xhr.open(a.method,a.url,!0,a.username,a.password),this.setHeaders(),this._xhr.send(a.data)}catch(b){this._deferred.reject(b)}},destroy:function(){this._ajax=this._opt=this._deferred=this._xhr=null}},!0,!1);var M=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};r(M.prototype,{_opt:null,_deferred:null,_ajax:null,
_el:null,send:function(){var a=document.createElement("script");a.setAttribute("async","async");a.setAttribute("charset","utf-8");a.setAttribute("src",this._opt.url);t(a,"load",g(this.onLoad,this));t(a,"error",g(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&
this._el.parentNode.removeChild(this._el);this._deferred=this._ajax=this._opt=this._el=null}},!0,!1);var K=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};r(K.prototype,{_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),b="frame-"+H(),c=this._opt.form;a.setAttribute("id",b);a.setAttribute("name",b);a.style.display="none";document.body.appendChild(a);c.setAttribute("action",this._opt.url);c.setAttribute("target",b);t(a,"load",g(this.onLoad,
this));t(a,"error",g(this.onError,this));this._el=a;try{c.submit()}catch(e){this._deferred.reject(e)}},onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponse(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);this._deferred=this._ajax=this._opt=
this._el=null}},!0,!1);return l}()});
