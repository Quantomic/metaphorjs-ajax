define("metaphorjs-ajax",["metaphorjs-observable","metaphorjs-promise","metaphorjs-select"],function(O,w,D){var x=Array.prototype.slice,y=Object.prototype.toString,s=function(){var b={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(e){if(!e){if(null===e)return 6;if(void 0===e)return 7}var f=b[y.call(e)];return void 0===f?-1:1==f&&isNaN(e)?8:f}}(),t=function(b){return"object"==
typeof b&&3===s(b)&&!b.nodeType},v=function(b){return!0===b||!1===b},z=function(){return function e(){var f=!1,g=!1,n=x.call(arguments),k=n.shift(),m,h,r;v(n[n.length-1])&&(f=n.pop());v(n[n.length-1])&&(g=f,f=n.pop());for(;n.length;)if(m=n.shift())for(h in m)if(m.hasOwnProperty(h)&&void 0!==(r=m[h]))if(g)if(k[h]&&t(k[h])&&t(r))e(k[h],r,f,g);else{if(!0===f||void 0==k[h])t(r)?(k[h]={},e(k[h],r,f,!0)):k[h]=r}else if(!0===f||void 0==k[h])k[h]=r;return k}}(),g=Function.prototype.bind?function(b,e){return b.bind(e)}:
function(b,e){return function(){return b.apply(e,arguments)}},m=function(b){return"string"==typeof b||0===s(b)},E=function(){return String.prototype.trim?function(b){return m(b)?b.trim():b}:function(b){return m(b)?b.replace(/^\s\s*/,"").replace(/\s\s*$/,""):b}}(),F=function(b,e,f){setTimeout(function(){b.apply(e,f||[])},0)},A=function(){},P=function(){return"undefined"!=typeof JSON?function(b){return JSON.parse(b)}:function(b){return(new Function("return "+b))()}}(),G=function(b,e){var f,g;if(!b||
!m(b))return null;try{g=new DOMParser,f=g.parseFromString(b,e||"text/xml")}catch(n){f=void 0}if(!f||f.getElementsByTagName("parsererror").length)throw"Invalid XML: "+b;return f},u=function(b,e,f){b.attachEvent?b.attachEvent("on"+e,f):b.addEventListener(e,f,!1)},B=function(b){if(null===b||"object"!=typeof b)return!1;b=s(b);return 2<b||-1==b},Q=function(b){var e=b.stack||Error().stack;if("undefined"!=typeof console&&console.log)F(function(){console.log(b);e&&console.log(e)});else throw b;},H=function(){var b=
["0","0","0"];return function(){for(var e=b.length,f;e;){e--;f=b[e].charCodeAt(0);if(57==f)return b[e]="A",b.join("");if(90==f)b[e]="0";else return b[e]=String.fromCharCode(f+1),b.join("")}b.unshift("0");return b.join("")}}();return function(){var b=/#.*$/,e=/([?&])_=[^&]*/,f=/\?/,t=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=/^(?:GET|HEAD)$/i,k=function(a,c,d){var q,b;b=s(a);if(3>b&&-1<b&&d)c.push(encodeURIComponent(d)+"="+encodeURIComponent(""+a));else if("object"==typeof a&&5===
s(a)&&d)for(q=0,b=a.length;q<b;q++)k(a[q],c,d+"["+q+"]");else if(B(a))for(q in a)a.hasOwnProperty(q)&&k(a[q],c,d?d+"["+q+"]":q)},v=function(a,c){a.replace(b,"");if(!1===c.cache){var d=(new Date).getTime();return e.test(a)?a.replace(e,"$1_="+d):a+(f.test(a)?"&":"?")+"_="+d}!c.data||window.FormData&&c.data instanceof window.FormData||(m(c.data)?d=c.data:(d=[],k(c.data,d,null),d=d.join("&").replace(/%20/g,"+")),c.data=d,n.test(c.method)&&(a+=(f.test(a)?"&":"?")+c.data,c.data=null));return a},h={xml:"application/xml, text/xml",
html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},r={url:null,data:null,method:"GET",headers:null,username:null,password:null,cache:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpParam:null,jsonpCallback:null,transport:null,replace:!1,selector:null,form:null,beforeSend:null,progress:null,uploadProgress:null,processResponse:null,callbackScope:null},I=
{},p=new O,J=function(a){var c;c=eval;a&&(/^[^\S]*use strict/.test(a)?(c=document.createElement("script"),c.text=a,document.head.appendChild(c).parentNode.removeChild(c)):c(a))},C=function(a,c,d){var b,e;if(!B(a)&&"function"!=typeof a&&d)b=document.createElement("input"),b.setAttribute("type","hidden"),b.setAttribute("name",d),b.setAttribute("value",a),c.appendChild(b);else if("object"==typeof a&&5===s(a)&&d)for(b=0,e=a.length;b<e;b++)C(a[b],c,d+"["+b+"]");else if(B(a))for(b in a)a.hasOwnProperty(b)&&
C(a[b],c,d?d+"["+b+"]":b)},x=function(a){for(var c,d,b="",e=0;e<a.elements.length;e++)if(c=a.elements[e],c.hasAttribute("name"))if(d="INPUT"===c.nodeName.toUpperCase()?c.getAttribute("type").toUpperCase():"TEXT","FILE"===d)for(d=0;d<c.files.length;b+="&"+encodeURIComponent(c.name)+"="+encodeURIComponent(c.files[d++].name));else if("RADIO"!==d&&"CHECKBOX"!==d||c.checked)b+="&"+encodeURIComponent(c.name)+"="+encodeURIComponent(c.value);return b},y=function(a,c,d){var b=c?c.dataType:null;c=c?c.selector:
null;if(!m(a))return a;d=d||"";if("xml"===b||!b&&0<=d.indexOf("xml"))return a=G(E(a)),c?D(c,a):a;if("html"===b)return a=G(a,"text/html"),c?D(c,a):a;if("fragment"==b){d=document.createDocumentFragment();b=document.createElement("div");for(b.innerHTML=a;b.firstChild;)d.appendChild(b.firstChild);return d}if("json"===b||!b&&0<=d.indexOf("json"))return P(E(a));("script"===b||!b&&0<=d.indexOf("javascript"))&&J(a);return a+""},N=function(a){var c=t.exec((window?window.location.href:"").toLowerCase())||[],
b=t.exec(a.url.toLowerCase());this._opt=a;!0!==a.crossDomain&&(a.crossDomain=!(!b||b[1]===c[1]&&b[2]===c[2]&&(b[3]||("http:"===b[1]?"80":"443"))===(c[3]||("http:"===c[1]?"80":"443"))));c=new w;"iframe"!=a.transport||a.form?a.form&&(this._form=a.form,"POST"!=a.method||window&&window.FormData||(a.transport="iframe")):(this.createForm(),a.form=this._form);a.form&&"iframe"!=a.transport&&(a.data="POST"==a.method?new FormData(a.form):x(a.form));a.url=v(a.url,a);b=!a.crossDomain&&"script"!=a.transport||
a.form?"iframe"==a.transport?new K(a,c,this):new L(a,c,this):new M(a,c,this);this._deferred=c;this._transport=b;c.done(function(a){p.trigger("success",a)});c.fail(function(a){p.trigger("error",a)});c.always(function(){p.trigger("end")});p.trigger("start");a.timeout&&(this._timeout=setTimeout(g(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();!1===p.trigger("beforeSend",a,b)&&(this._promise=w.reject());a.beforeSend&&!1===a.beforeSend.call(a.callbackScope,a,b)&&(this._promise=w.reject());
this._promise||(F(b.send,b),c.abort=g(this.abort,this),c.always(this.destroy,this),this._promise=c)};N.prototype={_jsonpName:null,_transport:null,_opt:null,_deferred:null,_promise:null,_timeout:null,_form:null,_removeForm:!1,promise:function(){return this._promise},abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=document.createElement("form");a.style.display="none";a.setAttribute("method",this._opt.method);
C(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},createJsonp:function(){var a=this._opt,c=a.jsonpParam||"callback",b=a.jsonpCallback||"jsonp_"+H();a.url+=(f.test(a.url)?"&":"?")+c+"="+b;this._jsonpName=b;"undefined"!=typeof window&&(window[b]=g(this.jsonpCallback,this));"undefined"!=typeof global&&(global[b]=g(this.jsonpCallback,this));return b},jsonpCallback:function(a){var c;try{c=this.processResponseData(a)}catch(b){this._deferred?this._deferred.reject(b):
Q(b)}this._deferred&&this._deferred.resolve(c)},processResponseData:function(a,c){var b=this._opt;a=y(a,b,c);p.hasListener("processResponse")&&(a=p.trigger("processResponse",a,this._deferred));b.processResponse&&(a=b.processResponse.call(b.callbackScope,a,this._deferred));return a},processResponse:function(a,c){var b=this._deferred,e;if(this._opt.jsonp)if(a){try{J(a)}catch(f){b.reject(f)}b.isPending()&&b.reject("jsonp script didn't invoke callback")}else b.reject("jsonp script is empty");else{try{e=
this.processResponseData(a,c)}catch(g){b.reject(g)}b.resolve(e)}},destroy:function(){this._timeout&&clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();delete this._transport;delete this._opt;delete this._deferred;delete this._promise;delete this._timeout;delete this._form;this._jsonpName&&("undefined"!=typeof window&&delete window[this._jsonpName],"undefined"!=typeof global&&delete global[this._jsonpName])}};
var l=function(a,b){b=b||{};a&&!m(a)?b=a:b.url=a;if(!b.url&&(b.form&&(b.url=b.form.getAttribute("action")),!b.url))throw"Must provide url";z(b,I,!1,!0);z(b,r,!1,!0);b.method=b.method?b.method.toUpperCase():b.form?b.form.getAttribute("method").toUpperCase()||"GET":"GET";return(new N(b)).promise()};l.setup=function(a){z(I,a,!0,!0)};l.on=function(){p.on.apply(p,arguments)};l.un=function(){p.un.apply(p,arguments)};l.get=function(a,b){b=b||{};b.method="GET";return l(a,b)};l.post=function(a,b){b=b||{};
b.method="POST";return l(a,b)};l.load=function(a,b,d){d=d||{};m(b)||(d=b);d.dataType="fragment";return l(b,d).done(function(b){if(d.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(b)})};l.loadScript=function(a){return l(a,{transport:"script"})};l.submit=function(a,b){b=b||{};b.form=a;return l(null,b)};var L=function(a,b,d){var e;if(!(window.XMLHttpRequest&&(e=new XMLHttpRequest)||(e=new ActiveXObject("Msxml2.XMLHTTP"))||(e=new ActiveXObject("Microsoft.XMLHTTP"))))throw"Unable to create XHR object";
this._xhr=e;this._deferred=b;this._opt=a;this._ajax=d;a.progress&&u(e,"progress",g(a.progress,a.callbackScope));a.uploadProgress&&e.upload&&u(e.upload,"progress",g(a.uploadProgress,a.callbackScope));e.onreadystatechange=g(this.onReadyStateChange,this)};L.prototype={_xhr:null,_deferred:null,_ajax:null,setHeaders:function(){var a=this._opt,b=this._xhr,d;if(a.xhrFields)for(d in a.xhrFields)b[d]=a.xhrFields[d];a.data&&a.contentType&&b.setRequestHeader("Content-Type",a.contentType);b.setRequestHeader("X-Requested-With",
"XMLHttpRequest");b.setRequestHeader("Accept",a.dataType&&h[a.dataType]?h[a.dataType]+", */*; q=0.01":h._default);for(d in a.headers)b.setRequestHeader(d,a.headers[d])},onReadyStateChange:function(){var a=this._xhr,b=this._deferred;if(0===a.readyState)a.onreadystatechange=A,b.resolve(a);else if(4===a.readyState){a.onreadystatechange=A;var d;a:{try{d=!a.status&&location&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(e){}d=!1}d?this._ajax.processResponse(m(a.responseText)?
a.responseText:void 0,a.getResponseHeader("content-type")||""):b.reject(a)}},abort:function(){this._xhr.onreadystatechange=A;this._xhr.abort()},send:function(){var a=this._opt;try{this._xhr.open(a.method,a.url,!0,a.username,a.password),this.setHeaders(),this._xhr.send(a.data)}catch(b){this._deferred.reject(b)}},destroy:function(){delete this._xhr;delete this._deferred;delete this._opt;delete this._ajax}};var M=function(a,b,d){this._opt=a;this._ajax=d;this._deferred=b};M.prototype={_opt:null,_deferred:null,
_ajax:null,_el:null,send:function(){var a=document.createElement("script");a.setAttribute("async","async");a.setAttribute("charset","utf-8");a.setAttribute("src",this._opt.url);u(a,"load",g(this.onLoad,this));u(a,"error",g(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&
this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};var K=function(a,b,d){this._opt=a;this._ajax=d;this._deferred=b};K.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),b="frame-"+H(),d=this._opt.form;a.setAttribute("id",b);a.setAttribute("name",b);a.style.display="none";document.body.appendChild(a);d.setAttribute("action",this._opt.url);d.setAttribute("target",b);u(a,"load",
g(this.onLoad,this));u(a,"error",g(this.onError,this));this._el=a;try{d.submit()}catch(e){this._deferred.reject(e)}},onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponse(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;
delete this._opt;delete this._ajax;delete this._deferred}};return l}()});
