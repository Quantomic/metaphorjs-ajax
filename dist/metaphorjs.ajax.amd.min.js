define("metaphorjs-ajax",["metaphorjs-observable","metaphorjs-promise","metaphorjs-select"],function(O,w,D){var x=Array.prototype.slice,y=Object.prototype.toString,s=function(){var b={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(c){if(!c){if(null===c)return 6;if(void 0===c)return 7}var f=b[y.call(c)];return void 0===f?-1:1==f&&isNaN(c)?8:f}}(),t=function(b){return"object"==
typeof b&&3===s(b)&&!b.nodeType},v=function(b){return!0===b||!1===b},z=function(){return function c(){var f=!1,g=!1,n=x.call(arguments),l=n.shift(),h,k,q;v(n[n.length-1])&&(f=n.pop());v(n[n.length-1])&&(g=f,f=n.pop());for(;n.length;)if(h=n.shift())for(k in h)if(h.hasOwnProperty(k)&&void 0!==(q=h[k]))if(g)if(l[k]&&t(l[k])&&t(q))c(l[k],q,f,g);else{if(!0===f||void 0==l[k])t(q)?(l[k]={},c(l[k],q,f,!0)):l[k]=q}else if(!0===f||void 0==l[k])l[k]=q;return l}}(),h=Function.prototype.bind?function(b,c){return b.bind(c)}:
function(b,c){return function(){return b.apply(c,arguments)}},r=function(b){return"string"==typeof b||0===s(b)},E=function(){return String.prototype.trim?function(b){return r(b)?b.trim():b}:function(b){return r(b)?b.replace(/^\s\s*/,"").replace(/\s\s*$/,""):b}}(),F=function(b,c,f){setTimeout(function(){b.apply(c,f||[])},0)},A=function(){},P=function(){return"undefined"!=typeof JSON?function(b){return JSON.parse(b)}:function(b){return(new Function("return "+b))()}}(),G=function(b,c){var f,g;if(!b||
!r(b))return null;try{g=new DOMParser,f=g.parseFromString(b,c||"text/xml")}catch(h){f=void 0}if(!f||f.getElementsByTagName("parsererror").length)throw"Invalid XML: "+b;return f},u=function(b,c,f){b.attachEvent?b.attachEvent("on"+c,f):b.addEventListener(c,f,!1)},B=function(b){if(null===b||"object"!=typeof b)return!1;b=s(b);return 2<b||-1==b},Q=function(b){var c=b.stack||Error().stack;if("undefined"!=typeof console&&console.log)F(function(){console.log(b);c&&console.log(c)});else throw b;},H=function(){var b=
["0","0","0"];return function(){for(var c=b.length,f;c;){c--;f=b[c].charCodeAt(0);if(57==f)return b[c]="A",b.join("");if(90==f)b[c]="0";else return b[c]=String.fromCharCode(f+1),b.join("")}b.unshift("0");return b.join("")}}(),g=function(b,c,f){return b&&b.getAttribute?void 0===f?b.getAttribute(c):null===f?b.removeAttribute(c):b.setAttribute(c,f):null};return function(){var b=/#.*$/,c=/([?&])_=[^&]*/,f=/\?/,t=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=/^(?:GET|HEAD)$/i,l=function(a,
d,e){var b,c;c=s(a);if(3>c&&-1<c&&e)d.push(encodeURIComponent(e)+"="+encodeURIComponent(""+a));else if("object"==typeof a&&5===s(a)&&e)for(b=0,c=a.length;b<c;b++)l(a[b],d,e+"["+b+"]");else if(B(a))for(b in a)a.hasOwnProperty(b)&&l(a[b],d,e?e+"["+b+"]":b)},v=function(a,d){a.replace(b,"");if(!1===d.cache){var e=(new Date).getTime();return c.test(a)?a.replace(c,"$1_="+e):a+(f.test(a)?"&":"?")+"_="+e}!d.data||window.FormData&&d.data instanceof window.FormData||(r(d.data)?e=d.data:(e=[],l(d.data,e,null),
e=e.join("&").replace(/%20/g,"+")),d.data=e,n.test(d.method)&&(a+=(f.test(a)?"&":"?")+d.data,d.data=null));return a},k={xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"},q={url:null,data:null,method:"GET",headers:null,username:null,password:null,cache:null,dataType:null,timeout:0,contentType:"application/x-www-form-urlencoded",xhrFields:null,jsonp:!1,jsonpParam:null,jsonpCallback:null,
transport:null,replace:!1,selector:null,form:null,beforeSend:null,progress:null,uploadProgress:null,processResponse:null,callbackScope:null},I={},p=new O,J=function(a){var d;d=eval;a&&(/^[^\S]*use strict/.test(a)?(d=document.createElement("script"),d.text=a,document.head.appendChild(d).parentNode.removeChild(d)):d(a))},C=function(a,d,e){var b,c;if(!B(a)&&"function"!=typeof a&&e)b=document.createElement("input"),g(b,"type","hidden"),g(b,"name",e),g(b,"value",a),d.appendChild(b);else if("object"==typeof a&&
5===s(a)&&e)for(b=0,c=a.length;b<c;b++)C(a[b],d,e+"["+b+"]");else if(B(a))for(b in a)a.hasOwnProperty(b)&&C(a[b],d,e?e+"["+b+"]":b)},x=function(a){for(var d,e,b="",c=0;c<a.elements.length;c++)if(d=a.elements[c],null!==g(d,"name"))if(e="INPUT"===d.nodeName.toUpperCase()?g(d,"type").toUpperCase():"TEXT","FILE"===e)for(e=0;e<d.files.length;b+="&"+encodeURIComponent(d.name)+"="+encodeURIComponent(d.files[e++].name));else if("RADIO"!==e&&"CHECKBOX"!==e||d.checked)b+="&"+encodeURIComponent(d.name)+"="+
encodeURIComponent(d.value);return b},y=function(a,d,b){var c=d?d.dataType:null;d=d?d.selector:null;if(!r(a))return a;b=b||"";if("xml"===c||!c&&0<=b.indexOf("xml"))return a=G(E(a)),d?D(d,a):a;if("html"===c)return a=G(a,"text/html"),d?D(d,a):a;if("fragment"==c){b=document.createDocumentFragment();c=document.createElement("div");for(c.innerHTML=a;c.firstChild;)b.appendChild(c.firstChild);return b}if("json"===c||!c&&0<=b.indexOf("json"))return P(E(a));("script"===c||!c&&0<=b.indexOf("javascript"))&&
J(a);return a+""},N=function(a){var d=t.exec((window?window.location.href:"").toLowerCase())||[],b=t.exec(a.url.toLowerCase());this._opt=a;!0!==a.crossDomain&&(a.crossDomain=!(!b||b[1]===d[1]&&b[2]===d[2]&&(b[3]||("http:"===b[1]?"80":"443"))===(d[3]||("http:"===d[1]?"80":"443"))));d=new w;"iframe"!=a.transport||a.form?a.form&&(this._form=a.form,"POST"!=a.method||window&&window.FormData||(a.transport="iframe")):(this.createForm(),a.form=this._form);a.form&&"iframe"!=a.transport&&(a.data="POST"==a.method?
new FormData(a.form):x(a.form));a.url=v(a.url,a);b=!a.crossDomain&&"script"!=a.transport||a.form?"iframe"==a.transport?new K(a,d,this):new L(a,d,this):new M(a,d,this);this._deferred=d;this._transport=b;d.done(function(a){p.trigger("success",a)});d.fail(function(a){p.trigger("error",a)});d.always(function(){p.trigger("end")});p.trigger("start");a.timeout&&(this._timeout=setTimeout(h(this.onTimeout,this),a.timeout));a.jsonp&&this.createJsonp();!1===p.trigger("beforeSend",a,b)&&(this._promise=w.reject());
a.beforeSend&&!1===a.beforeSend.call(a.callbackScope,a,b)&&(this._promise=w.reject());this._promise||(F(b.send,b),d.abort=h(this.abort,this),d.always(this.destroy,this),this._promise=d)};N.prototype={_jsonpName:null,_transport:null,_opt:null,_deferred:null,_promise:null,_timeout:null,_form:null,_removeForm:!1,promise:function(){return this._promise},abort:function(a){this._transport.abort();this._deferred.reject(a||"abort")},onTimeout:function(){this.abort("timeout")},createForm:function(){var a=
document.createElement("form");a.style.display="none";g(a,"method",this._opt.method);C(this._opt.data,a,null);document.body.appendChild(a);this._form=a;this._removeForm=!0},createJsonp:function(){var a=this._opt,d=a.jsonpParam||"callback",b=a.jsonpCallback||"jsonp_"+H();a.url+=(f.test(a.url)?"&":"?")+d+"="+b;this._jsonpName=b;"undefined"!=typeof window&&(window[b]=h(this.jsonpCallback,this));"undefined"!=typeof global&&(global[b]=h(this.jsonpCallback,this));return b},jsonpCallback:function(a){var d;
try{d=this.processResponseData(a)}catch(b){this._deferred?this._deferred.reject(b):Q(b)}this._deferred&&this._deferred.resolve(d)},processResponseData:function(a,b){var e=this._opt;a=y(a,e,b);p.hasListener("processResponse")&&(a=p.trigger("processResponse",a,this._deferred));e.processResponse&&(a=e.processResponse.call(e.callbackScope,a,this._deferred));return a},processResponse:function(a,b){var e=this._deferred,c;if(this._opt.jsonp)if(a){try{J(a)}catch(f){e.reject(f)}e.isPending()&&e.reject("jsonp script didn't invoke callback")}else e.reject("jsonp script is empty");
else{try{c=this.processResponseData(a,b)}catch(g){e.reject(g)}e.resolve(c)}},destroy:function(){this._timeout&&clearTimeout(this._timeout);this._form&&this._form.parentNode&&this._removeForm&&this._form.parentNode.removeChild(this._form);this._transport.destroy();delete this._transport;delete this._opt;delete this._deferred;delete this._promise;delete this._timeout;delete this._form;this._jsonpName&&("undefined"!=typeof window&&delete window[this._jsonpName],"undefined"!=typeof global&&delete global[this._jsonpName])}};
var m=function(a,b){b=b||{};a&&!r(a)?b=a:b.url=a;if(!b.url&&(b.form&&(b.url=g(b.form,"action")),!b.url))throw"Must provide url";z(b,I,!1,!0);z(b,q,!1,!0);b.method=b.method?b.method.toUpperCase():b.form?g(b.form,"method").toUpperCase()||"GET":"GET";return(new N(b)).promise()};m.setup=function(a){z(I,a,!0,!0)};m.on=function(){p.on.apply(p,arguments)};m.un=function(){p.un.apply(p,arguments)};m.get=function(a,b){b=b||{};b.method="GET";return m(a,b)};m.post=function(a,b){b=b||{};b.method="POST";return m(a,
b)};m.load=function(a,b,e){e=e||{};r(b)||(e=b);e.dataType="fragment";return m(b,e).done(function(b){if(e.replace)for(;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(b)})};m.loadScript=function(a){return m(a,{transport:"script"})};m.submit=function(a,b){b=b||{};b.form=a;return m(null,b)};var L=function(a,b,e){var c;if(!(window.XMLHttpRequest&&(c=new XMLHttpRequest)||(c=new ActiveXObject("Msxml2.XMLHTTP"))||(c=new ActiveXObject("Microsoft.XMLHTTP"))))throw"Unable to create XHR object";this._xhr=
c;this._deferred=b;this._opt=a;this._ajax=e;a.progress&&u(c,"progress",h(a.progress,a.callbackScope));a.uploadProgress&&c.upload&&u(c.upload,"progress",h(a.uploadProgress,a.callbackScope));c.onreadystatechange=h(this.onReadyStateChange,this)};L.prototype={_xhr:null,_deferred:null,_ajax:null,setHeaders:function(){var a=this._opt,b=this._xhr,c;if(a.xhrFields)for(c in a.xhrFields)b[c]=a.xhrFields[c];a.data&&a.contentType&&b.setRequestHeader("Content-Type",a.contentType);b.setRequestHeader("X-Requested-With",
"XMLHttpRequest");b.setRequestHeader("Accept",a.dataType&&k[a.dataType]?k[a.dataType]+", */*; q=0.01":k._default);for(c in a.headers)b.setRequestHeader(c,a.headers[c])},onReadyStateChange:function(){var a=this._xhr,b=this._deferred;if(0===a.readyState)a.onreadystatechange=A,b.resolve(a);else if(4===a.readyState){a.onreadystatechange=A;var c;a:{try{c=!a.status&&location&&"file:"==location.protocol||200<=a.status&&300>a.status||304===a.status||1223===a.status;break a}catch(f){}c=!1}c?this._ajax.processResponse(r(a.responseText)?
a.responseText:void 0,a.getResponseHeader("content-type")||""):b.reject(a)}},abort:function(){this._xhr.onreadystatechange=A;this._xhr.abort()},send:function(){var a=this._opt;try{this._xhr.open(a.method,a.url,!0,a.username,a.password),this.setHeaders(),this._xhr.send(a.data)}catch(b){this._deferred.reject(b)}},destroy:function(){delete this._xhr;delete this._deferred;delete this._opt;delete this._ajax}};var M=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};M.prototype={_opt:null,_deferred:null,
_ajax:null,_el:null,send:function(){var a=document.createElement("script");g(a,"async","async");g(a,"charset","utf-8");g(a,"src",this._opt.url);u(a,"load",h(this.onLoad,this));u(a,"error",h(this.onError,this));document.head.appendChild(a);this._el=a},onLoad:function(a){this._deferred&&this._deferred.resolve(a)},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);
delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};var K=function(a,b,c){this._opt=a;this._ajax=c;this._deferred=b};K.prototype={_opt:null,_deferred:null,_ajax:null,_el:null,send:function(){var a=document.createElement("iframe"),b="frame-"+H(),c=this._opt.form;g(a,"id",b);g(a,"name",b);a.style.display="none";document.body.appendChild(a);g(c,"action",this._opt.url);g(c,"target",b);u(a,"load",h(this.onLoad,this));u(a,"error",h(this.onError,this));this._el=a;try{c.submit()}catch(f){this._deferred.reject(f)}},
onLoad:function(){var a=this._el;this._opt&&!this._opt.jsonp&&(a=a.contentDocument||a.contentWindow.document,a=a.body.innerHTML,this._ajax.processResponse(a))},onError:function(a){this._deferred.reject(a)},abort:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el)},destroy:function(){this._el.parentNode&&this._el.parentNode.removeChild(this._el);delete this._el;delete this._opt;delete this._ajax;delete this._deferred}};return m}()});
